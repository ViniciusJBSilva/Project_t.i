from flask import Flask, render_template, request, redirect
import mysql.connector
import json
import shutil
from gmplot import GoogleMapPlotter

app = Flask(__name__, template_folder='templates')

db_config = {
    'host': 'localhost',
    'user': 'root',
    'password': '123456',
    'database': 'db_ti'
}

#renderização das html

@app.route('/', methods=['GET'])
def formulario():
    return render_template('home.html')


@app.route('/cadastro', methods=['GET'])
def exibir_cadastro():
    return render_template('cadastro.html')


@app.route('/cadastrook', methods=['GET'])
def exibit_cadastro_feito():
    return render_template('cadastrook.html')

@app.route('/login', methods=['GET'])
def exibir_login():
    return render_template('login.html')

@app.route('/map', methods=['GET'])
def exibir_map():
    return render_template('map.html')


@app.route('/posicao', methods=['GET'])
def exibir_posicao():
    return render_template('posicao.html')






@app.route('/cadastro', methods=['POST'])
def cadastrar():
    user = request.form['user']
    password = request.form['password']

    conexao = mysql.connector.connect(**db_config)
    cursor = conexao.cursor()

    consulta = "SELECT * FROM cadastro WHERE user = %s"
    valores = (user,)
    cursor.execute(consulta, valores)
    resultado = cursor.fetchone()

    if resultado:
        return 'Nome de usuario ja cadastrado em sistema!'
    
    else:
        insercao = "INSERT INTO `cadastro` (`user`, `password`) VALUES (%s, %s)"
        valores = (user, password)
        cursor.execute(insercao, valores)
        conexao.commit()

        cursor.close()
        conexao.close()

    
        return redirect('/cadastrook')




@app.route('/login', methods=['GET', 'POST'])
def login():
        user = request.form['user']
        password = request.form['password']

        conexao = mysql.connector.connect(**db_config)
        cursor = conexao.cursor()

        consulta = "SELECT * FROM `cadastro` WHERE `user` = %s AND `password` = %s"
        valores = (user, password)
        cursor.execute(consulta, valores)
        resultado = cursor.fetchone()

        cursor.close()
        conexao.close()

        if resultado:
            return redirect('/posicao')
        else:
        
            return "Usuário ou senha incorretos"
        



@app.route('/posicao', methods=['POST'])
def posi():
    with open('position.json') as file:
        data = json.load(file)


    coordinates = [(float(item['latitude']), float(item['longitude'])) for item in data['data']]


    gmap = GoogleMapPlotter(coordinates[0][0], coordinates[0][1], zoom=12)


    for lat, lon in coordinates:
        gmap.marker(lat, lon)


    output_file = 'map.html'
    gmap.draw(output_file)


    destination_folder = 'templates/'
    shutil.move(output_file, destination_folder + output_file)


    return redirect('/map')




if __name__ == '__main__':
    app.run(debug=True)
